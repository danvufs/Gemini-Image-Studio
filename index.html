<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Studio ·∫¢nh Ph√©p Thu·∫≠t Gemini</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <style>
    :root {
     
      --primary-color: #4A90E2;
      --primary-light: #82B1FF;
      --primary-dark: #004BA0;
      --accent-color: #50E3C2;
      --text-color: #333333;
      --bg-color: #f4f7fc;
      --card-bg: #FFFFFF;
      --shadow: 0 8px 20px rgba(74, 144, 226, 0.15);
      --gradient: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
      min-height: 100vh;
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
    }
    
    header {
      background: var(--gradient);
      color: white;
      padding: 30px 20px;
      text-align: center;
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 2;
    }
    
    header h1 {
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
    
    header p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    
    header .header-icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }
    
    /* Container ch√≠nh c·ªßa trang */
    .container {
      max-width: 1000px;
      margin: -20px auto 40px; /* C√°ch header h·ª£p l√Ω */
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 40px;
      transition: var(--transition);
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(74, 144, 226, 0.2);
    }
    
    @keyframes containerFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .container {
      animation: containerFadeIn 1s ease-out;
    }
    
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--gradient);
    }
    
 
    .upload-area {
      border: 2px dashed rgba(74, 144, 226, 0.3);
      border-radius: var(--border-radius);
      padding: 25px;
      text-align: center;
      margin-bottom: 30px;
      transition: var(--transition);
      cursor: pointer;
      background-color: rgba(74, 144, 226, 0.02);
      position: relative;
      overflow: hidden;
    }
    
    .upload-area:hover {
      border-color: var(--primary-color);
      background-color: rgba(74, 144, 226, 0.05);
      transform: translateY(-3px);
    }
    
    .upload-area.dragover {
      border-color: var(--primary-color);
      background-color: rgba(74, 144, 226, 0.1);
      transform: scale(1.01);
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
      color: var(--primary-color);
      transition: var(--transition);
    }
    
    .upload-area:hover .upload-icon {
      transform: scale(1.1) rotate(5deg);
      filter: drop-shadow(0 0 5px rgba(74, 144, 226, 0.6));
    }
    
    .upload-text {
      color: var(--text-color);
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .small {
      font-size: 0.85em;
      color: #888;
      font-weight: 400;
    }
    
    .example-prompts {
      margin: 15px 0 25px;
    }
    
    .example-btn {
      display: inline-block;
      margin: 5px 5px 5px 0;
      padding: 8px 16px;
      background-color: rgba(74, 144, 226, 0.1);
      color: var(--primary-color);
      border: none;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 5px rgba(74, 144, 226, 0.1);
      background-image: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(80, 227, 194, 0.1));
    }
    
    .example-btn:hover {
      background-image: linear-gradient(135deg, rgba(74, 144, 226, 0.2), rgba(80, 227, 194, 0.2));
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 5px 10px rgba(74, 144, 226, 0.2);
    }
    
    .uploaded-images-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
      justify-content: center;
      will-change: contents;
    }
    
    .image-preview-wrapper {
      position: relative;
      width: 160px;
      height: 160px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
      transform: translateZ(0);
      will-change: transform, opacity;
    }
    
    .image-preview-wrapper:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .image-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }
    
    .image-preview-wrapper:hover .image-preview {
      transform: scale(1.05);
    }
    
    .image-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background-color: rgba(255, 255, 255, 0.9);
      color: #ff6666;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .image-preview-wrapper:hover .image-delete-btn {
      opacity: 1;
    }
    
    .image-delete-btn:hover {
      background-color: #ff6666;
      color: white;
      transform: rotate(90deg);
    }
    
    .upload-hint {
      text-align: center;
      margin: 15px 0;
      color: var(--primary-color);
      font-style: normal;
      display: none;
      font-weight: 500;
      background-color: rgba(74, 144, 226, 0.05);
      padding: 8px 15px;
      border-radius: 8px;
    }
    
    .input-group {
      margin-bottom: 25px;
      position: relative;
    }
    
    #promptInput {
      width: 100%;
      padding: 15px 18px;
      border: 2px solid rgba(74, 144, 226, 0.2);
      border-radius: 12px;
      font-size: 16px;
      transition: var(--transition);
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      background-color: rgba(255, 255, 255, 0.9);
    }
    
    #promptInput:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
      background-color: white;
    }
    
    #promptInput::placeholder {
      color: #aaa;
    }
    
    .button-container {
      display: flex;
      justify-content: center;
    }
    
    #generateButton {
      padding: 14px 35px;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.4s ease;
      box-shadow: 0 6px 15px rgba(74, 144, 226, 0.3);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.5px;
      z-index: 1;
      transform-style: preserve-3d;
    }
    
    #generateButton:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4);
    }
    
    #generateButton:active {
      transform: translateY(-1px) scale(1.02);
    }
    
    .loading-animation {
      display: none;
      text-align: center;
      margin: 30px 0;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(74, 144, 226, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .result-container {
      margin-top: 30px;
      display: none;
      will-change: transform;
      transform: translateZ(0);
    }
    
    .result-title {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 1.2rem;
    }
    
    .result-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .result-image-wrapper {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
      aspect-ratio: 1/1;
    }
    
    .result-image-wrapper:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(74, 144, 226, 0.2);
    }
    
    .result-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }
    
    .result-image-wrapper:hover .result-image {
      transform: scale(1.05);
    }
    
    .download-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: rgba(255, 255, 255, 0.9);
      color: var(--primary-color);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .result-image-wrapper:hover .download-btn {
      opacity: 1;
    }
    
    .download-btn:hover {
      background-color: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 25px 15px;
      }
      
      header h1 {
        font-size: 2.2rem;
      }
      
      .result-images {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }
    
    .error-message {
      background-color: #ffeeee;
      color: #ff5555;
      padding: 12px 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #ff5555;
      display: none;
    }
    
    .active {
      transform: scale(0.95);
    }
    .shake {
      animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .selected {
      animation: pulse 0.5s ease;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(80, 227, 194, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(80, 227, 194, 0); }
      100% { box-shadow: 0 0 0 0 rgba(80, 227, 194, 0); }
    }
    
    /* Hi·ªáu ·ª©ng gradient cho khung ·∫£nh k·∫øt qu·∫£ */
    .image-container {
      position: relative;
    }
    
    .image-container::after {
      content: "";
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border-radius: 20px;
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color), var(--primary-color));
      background-size: 200% 200%;
      z-index: -1;
      filter: blur(20px);
      opacity: 0;
      transition: opacity 0.5s ease;
      animation: gradientAnimation 6s ease infinite;
    }
    
    .image-container:hover::after {
      opacity: 0.5;
    }
    
    @keyframes gradientAnimation {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    
    footer.footer {
      background: #333;
      color: #ccc;
      text-align: center;
      padding: 20px;
      font-size: 0.9rem;
      border-top: 1px solid #444;
      margin-top: 40px;
    }
    
    footer.footer p {
      margin: 5px 0;
    }
    
    footer.footer .social-icons {
      margin-top: 10px;
    }
    
    footer.footer .social-icons a {
      color: #ccc;
      margin: 0 8px;
      text-decoration: none;
      font-size: 1.2rem;
      transition: color 0.3s;
    }
    
    footer.footer .social-icons a:hover {
      color: white;
    }
  </style>
</head>
<body>
  <!-- Header hi·ªán ƒë·∫°i -->
  <header>
    <div class="header-icon">‚ú®</div>
    <h1>Studio ·∫¢nh Ph√©p Thu·∫≠t Gemini</h1>
    <p>N∆°i ngh·ªá thu·∫≠t v√† ma thu·∫≠t giao thoa</p>
  </header>
  
  <div class="container">
    <!-- Khu v·ª±c t·∫£i ·∫£nh l√™n -->
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üñºÔ∏è</div>
      <div class="upload-text">Nh·∫•p ho·∫∑c k√©o th·∫£ ·∫£nh v√†o ƒë√¢y ƒë·ªÉ t·∫£i l√™n</div>
      <div class="upload-text small">(H·ªó tr·ª£ nhi·ªÅu ·∫£nh) T·∫£i ·∫£nh l√™n ƒë·ªÉ bi·∫øn ƒë·ªïi ma thu·∫≠t</div>
      <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
    </div>
    
    <div class="safety-tips" style="margin-bottom: 20px; font-size: 0.85em; color: var(--primary-color); text-align: center; padding: 8px; background-color: rgba(74, 144, 226, 0.05); border-radius: 8px;">
      üí´ M·∫πo nh·ªè: Tr√°nh s·ª≠ d·ª•ng ·∫£nh ho·∫∑c g·ª£i √Ω c√≥ n·ªôi dung nh·∫°y c·∫£m ƒë·ªÉ kh√¥ng b·ªã h·ªá th·ªëng ch·∫∑n ‚ú®
    </div>
    
    <div class="uploaded-images-container" id="uploadedImagesContainer"></div>
    <div class="upload-hint" id="uploadHint">‚ú® Nh·∫•p v√†o ·∫£nh ƒë·ªÉ ch·ªçn ·∫£nh ch√≠nh x·ª≠ l√Ω</div>
    
    <div class="input-group">
      <input type="text" id="promptInput" placeholder="Nh·∫≠p ch·ªâ d·∫´n s√°ng t·∫°o c·ªßa b·∫°n (Hi·ªáu qu·∫£ nh·∫•t v·ªõi ti·∫øng Anh)" />
      <div class="prompt-optimization" style="margin-top: 10px; display: flex; align-items: center; justify-content: flex-end;">
        <label for="useOptimization" style="font-size: 0.85em; display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" id="useOptimization" checked style="margin-right: 5px;">
          <span>S·ª≠ d·ª•ng t·ªëi ∆∞u ma thu·∫≠t ‚ú®</span>
          <span class="tooltip" style="position: relative; margin-left: 5px; cursor: help;">
            ‚ÑπÔ∏è
            <span class="tooltip-text" style="visibility: hidden; position: absolute; width: 250px; background-color: rgba(74, 144, 226, 0.9); color: white; text-align: center; padding: 8px; border-radius: 6px; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-weight: normal;">
              T·ª± ƒë·ªông t·ªëi ∆∞u g·ª£i √Ω, gi√∫p tƒÉng t·ªâ l·ªá t·∫°o ·∫£nh th√†nh c√¥ng ‚Äì th√™m ti·ªÅn t·ªë v√† h·∫≠u t·ªë th√≠ch h·ª£p!
            </span>
          </span>
        </label>
      </div>
      <div class="example-prompts">
        <div class="small">G·ª£i √Ω:</div>
        <button class="example-btn" data-prompt="A cute bichoonpoo in space">C√∫n trong kh√¥ng gian</button>
        <button class="example-btn" data-prompt="Beautiful sunset over mountains">Ho√†ng h√¥n tr√™n n√∫i</button>
        <button class="example-btn" data-prompt="Futuristic city with flying cars">Th√†nh ph·ªë t∆∞∆°ng lai</button>
        <button class="example-btn" data-prompt="Underwater world with colorful fish">Th·∫ø gi·ªõi d∆∞·ªõi n∆∞·ªõc</button>
        <button class="example-btn" data-prompt="Fantasy forest with glowing plants">Khu r·ª´ng ph√©p thu·∫≠t</button>
      </div>
    </div>
    
    <div class="button-container">
      <button id="generateButton">‚ú® T·∫°o ·∫£nh ma thu·∫≠t</button>
    </div>
    <div class="loader" id="loader"></div>
    <div id="status"></div>
    <div class="image-container" id="imageContainer" style="display: none;">
      <img id="resultImage" src="" alt="·∫¢nh ƒë∆∞·ª£c t·∫°o" />
    </div>
    <div class="ai-message-container" id="aiMessageContainer">
      <div class="ai-message" id="aiMessage"></div>
    </div>
  </div>
  
  <!-- Footer hi·ªán ƒë·∫°i -->
  <footer class="footer">
    <p>¬© 2025 Studio ·∫¢nh Ph√©p Thu·∫≠t Gemini</p>
    <p>Thi·∫øt k·∫ø &amp; Ph√°t tri·ªÉn b·ªüi no name</p>
    
  </footer>
  
  <script>
    // Kh√≥a API
    const API_KEY = "AIzaSyDWEgz0SlQAudvxuB9XUh_IZ2H-vf660G4";
    
    // L·∫•y c√°c ph·∫ßn t·ª≠ DOM c·∫ßn thi·∫øt
    const promptInput = document.getElementById("promptInput");
    const generateButton = document.getElementById("generateButton");
    const status = document.getElementById("status");
    const resultImage = document.getElementById("resultImage");
    const imageContainer = document.getElementById("imageContainer");
    const loader = document.getElementById("loader");
    const uploadArea = document.getElementById("uploadArea");
    const imageInput = document.getElementById("imageInput");
    const uploadedImagesContainer = document.getElementById("uploadedImagesContainer");
    const uploadHint = document.getElementById("uploadHint");
    const exampleButtons = document.querySelectorAll(".example-btn");
    const useOptimization = document.getElementById("useOptimization");
    const tooltip = document.querySelector(".tooltip");
    const aiMessageContainer = document.getElementById("aiMessageContainer");
    const aiMessage = document.getElementById("aiMessage");
    
    // M·∫£ng l∆∞u tr·ªØ ·∫£nh ƒë√£ t·∫£i l√™n
    let uploadedImages = [];
    let selectedImageIndex = -1;
    
    // X·ª≠ l√Ω hi·ªÉn th·ªã tooltip t·ªëi ∆∞u g·ª£i √Ω
    if (tooltip) {
      tooltip.addEventListener("mouseenter", function() {
        const tooltipText = this.querySelector(".tooltip-text");
        requestAnimationFrame(() => {
          tooltipText.style.visibility = "visible";
          tooltipText.style.opacity = "1";
        });
      });
      
      tooltip.addEventListener("mouseleave", function() {
        const tooltipText = this.querySelector(".tooltip-text");
        requestAnimationFrame(() => {
          tooltipText.style.visibility = "hidden";
          tooltipText.style.opacity = "0";
        });
      });
    }
    
    // Hi·ªáu ·ª©ng load trang
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(() => {
        document.querySelector('.container').style.opacity = '0';
        requestAnimationFrame(() => {
          document.querySelector('.container').style.opacity = '1';
          document.querySelector('.container').style.transition = 'opacity 0.8s ease';
        });
      });
    });
    
    // X·ª≠ l√Ω s·ª± ki·ªán nh·∫•p v√†o n√∫t g·ª£i √Ω v√≠ d·ª•
    document.querySelector('.example-prompts').addEventListener('click', (event) => {
      const button = event.target.closest('.example-btn');
      if (!button) return;
      
      promptInput.value = button.getAttribute("data-prompt");
      promptInput.focus();
      button.classList.add('active');
      setTimeout(() => button.classList.remove('active'), 300);
    });
    
    // Th√™m s·ª± ki·ªán nh·∫•n ph√≠m Enter ƒë·ªÉ t·∫°o ·∫£nh
    promptInput.addEventListener("keyup", (event) => {
      if (event.key === "Enter") {
        generateImage();
      }
    });
    
    // R√†ng bu·ªôc s·ª± ki·ªán click cho n√∫t t·∫°o ·∫£nh
    generateButton.addEventListener("click", generateImage);
    
    // Khi ·∫£nh ƒë∆∞·ª£c load xong, th√™m hi·ªáu ·ª©ng hi·ªÉn th·ªã
    resultImage.addEventListener("load", () => {
      resultImage.classList.add("show");
    });
    
    // X·ª≠ l√Ω k√©o th·∫£ ·∫£nh
    uploadArea.addEventListener("dragover", (event) => {
      event.preventDefault();
      uploadArea.classList.add("dragover");
    });
    
    uploadArea.addEventListener("dragleave", () => {
      uploadArea.classList.remove("dragover");
    });
    
    uploadArea.addEventListener("drop", (event) => {
      event.preventDefault();
      uploadArea.classList.remove("dragover");
      const files = event.dataTransfer.files;
      handleMultipleImageUpload(files);
    });
    
    // M·ªü h·ªôp ch·ªçn file khi nh·∫•p v√†o khu v·ª±c t·∫£i ·∫£nh
    uploadArea.addEventListener("click", () => {
      imageInput.click();
      uploadArea.classList.add('active');
      setTimeout(() => uploadArea.classList.remove('active'), 300);
    });
    
    imageInput.addEventListener("change", () => {
      const files = imageInput.files;
      handleMultipleImageUpload(files);
    });
    
    // H√†m x·ª≠ l√Ω t·∫£i nhi·ªÅu ·∫£nh
    function handleMultipleImageUpload(files) {
      if (!files || files.length === 0) return;
      Array.from(files).forEach(file => {
        if (!file.type.match('image.*')) {
          showStatus(`T·ªáp "${file.name}" kh√¥ng ph·∫£i l√† ·∫£nh h·ª£p l·ªá`, "error");
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageData = {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            name: file.name,
            src: e.target.result,
            base64: e.target.result.split(',')[1]
          };
          uploadedImages.push(imageData);
          if (uploadedImages.length === 1) {
            selectedImageIndex = 0;
          }
          renderUploadedImages();
          showStatus(`·∫¢nh "${file.name}" t·∫£i l√™n th√†nh c√¥ng!`, "success");
          setTimeout(() => status.textContent = '', 2000);
        };
        reader.readAsDataURL(file);
      });
    }
    
    // H√†m render danh s√°ch ·∫£nh ƒë√£ t·∫£i l√™n
    function renderUploadedImages() {
      uploadedImagesContainer.innerHTML = '';
      if (uploadedImages.length === 0) {
        uploadHint.style.display = 'none';
        return;
      }
      uploadHint.style.display = 'block';
      const fragment = document.createDocumentFragment();
      uploadedImages.forEach((image, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'image-preview-wrapper';
        if (index === selectedImageIndex) {
          wrapper.style.border = '3px solid var(--primary-color)';
        }
        const img = document.createElement('img');
        img.className = 'image-preview';
        img.src = image.src;
        img.alt = image.name;
        img.title = image.name;
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'image-delete-btn';
        deleteBtn.innerHTML = '√ó';
        deleteBtn.title = 'X√≥a ·∫£nh';
        img.addEventListener('click', () => {
          selectedImageIndex = index;
          renderUploadedImages();
          wrapper.classList.add('selected');
          setTimeout(() => wrapper.classList.remove('selected'), 500);
        });
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          wrapper.style.transform = 'scale(0)';
          wrapper.style.opacity = '0';
          setTimeout(() => {
            uploadedImages.splice(index, 1);
            if (selectedImageIndex === index) {
              selectedImageIndex = uploadedImages.length > 0 ? 0 : -1;
            } else if (selectedImageIndex > index) {
              selectedImageIndex--;
            }
            renderUploadedImages();
          }, 300);
        });
        wrapper.appendChild(img);
        wrapper.appendChild(deleteBtn);
        fragment.appendChild(wrapper);
      });
      uploadedImagesContainer.appendChild(fragment);
      requestAnimationFrame(() => {
        const wrappers = uploadedImagesContainer.querySelectorAll('.image-preview-wrapper');
        wrappers.forEach((wrapper, index) => {
          wrapper.style.opacity = '0';
          wrapper.style.transform = 'translateY(20px)';
          requestAnimationFrame(() => {
            setTimeout(() => {
              wrapper.style.opacity = '1';
              wrapper.style.transform = 'translateY(0)';
              wrapper.style.transition = 'all 0.3s ease';
            }, 20 * index);
          });
        });
      });
    }
    
    // H√†m t·∫°o ·∫£nh b·∫±ng API Gemini
   async function generateImage() {
  const prompt = promptInput.value.trim();
  const totalImages = uploadedImages.length;
  
  // Ki·ªÉm tra nh·∫≠p li·ªáu
  if (!prompt) {
    showStatus("Vui l√≤ng nh·∫≠p g·ª£i √Ω! ‚ö†Ô∏è", "error");
    promptInput.classList.add('shake');
    setTimeout(() => promptInput.classList.remove('shake'), 500);
    return;
  }
  
  setLoading(true);
  showStatus("‚ú® ƒêang s·ª≠ d·ª•ng ma thu·∫≠t ƒë·ªÉ t·∫°o ·∫£nh...");
  imageContainer.style.display = "none";
  resultImage.classList.remove("show");
  aiMessageContainer.classList.remove('show');
  aiMessage.innerHTML = '';
  
  try {
    generateButton.innerHTML = "ƒêang t·∫°o ma thu·∫≠t...";
    
    // S·ª≠ d·ª•ng t·ªëi ∆∞u n·∫øu b·∫≠t
    const finalPrompt = useOptimization.checked ? optimizePrompt(prompt) : prompt;
    console.log("üîÆ G·ª£i √Ω s·ª≠ d·ª•ng:", finalPrompt);
    
    // Chu·∫©n b·ªã y√™u c·∫ßu g·ª≠i l√™n API
    const requestBody = {
      contents: [{
        parts: [{ text: finalPrompt }]
      }],
      generationConfig: {
        responseModalities: ["Text", "Image"]
      }
    };
    
    // N·∫øu c√≥ ·∫£nh ƒë∆∞·ª£c t·∫£i l√™n
    if (totalImages > 0) {
      // N·∫øu c√≥ 2 ·∫£nh tr·ªü l√™n, d√πng ·∫£nh ƒë·∫ßu ti√™n l√†m ch√≠nh, ·∫£nh th·ª© 2 l√†m tham chi·∫øu
      if (totalImages >= 2) {
        const primaryImage = uploadedImages[0];
        const referenceImage = uploadedImages[1];
        // Th√™m d·ªØ li·ªáu c·ªßa ·∫£nh tham chi·∫øu tr∆∞·ªõc, sau ƒë√≥ l√† ·∫£nh ch√≠nh
        requestBody.contents[0].parts.unshift(
          {
            inlineData: {
              mimeType: "image/jpeg",
              data: referenceImage.base64
            }
          },
          {
            inlineData: {
              mimeType: "image/jpeg",
              data: primaryImage.base64
            }
          }
        );
      } else {
        // N·∫øu ch·ªâ c√≥ 1 ·∫£nh, s·ª≠ d·ª•ng ·∫£nh ƒë√≥
        const primaryImage = uploadedImages[0];
        requestBody.contents[0].parts.unshift({
          inlineData: {
            mimeType: "image/jpeg",
            data: primaryImage.base64
          }
        });
      }
    }
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || "Y√™u c·∫ßu API th·∫•t b·∫°i");
    }
    
    const data = await response.json();
    
    if (data.promptFeedback && data.promptFeedback.blockReason) {
      const blockReason = data.promptFeedback.blockReason;
      console.log("üõë L√Ω do b·ªã ch·∫∑n:", blockReason);
      throw new Error(handleBlockReason(blockReason));
    }
    
    if (data.candidates && data.candidates[0] && data.candidates[0].finishReason) {
      const finishReason = data.candidates[0].finishReason;
      if (finishReason !== "STOP") {
        throw new Error(handleFinishReason(finishReason));
      }
    }
    
    const candidate = data.candidates && data.candidates[0];
    const content = candidate && candidate.content;
    const parts = content && content.parts;
    
    if (!parts || parts.length === 0) {
      throw new Error("API kh√¥ng tr·∫£ v·ªÅ n·ªôi dung n√†o");
    }
    
    // L·∫•y d·ªØ li·ªáu ·∫£nh t·ª´ ph·∫ßn inlineData (gi·∫£ s·ª≠ ch·ªâ c√≥ 1 ·∫£nh k·∫øt qu·∫£)
    const inlinePart = parts.find(part => part.inlineData);
    const imageData = inlinePart && inlinePart.inlineData && inlinePart.inlineData.data;
    
    // L·∫•y d·ªØ li·ªáu vƒÉn b·∫£n t·ª´ AI
    const textParts = parts.filter(part => part.text);
    let aiTextResponse = "";
    if (textParts && textParts.length > 0) {
      aiTextResponse = textParts.map(part => part.text).join("");
      const processedText = processAiText(aiTextResponse);
      aiMessage.innerHTML = processedText;
      setTimeout(() => { aiMessageContainer.classList.add('show'); }, 800);
    } else {
      aiMessageContainer.classList.remove('show');
    }
    
    if (imageData) {
      resultImage.src = `data:image/png;base64,${imageData}`;
      imageContainer.style.display = "block";
      setTimeout(() => {
        imageContainer.scrollIntoView({ behavior: 'smooth' });
        if (useOptimization.checked) {
          showStatus("‚ú® T·∫°o ·∫£nh th√†nh c√¥ng! T·ªëi ∆∞u ma thu·∫≠t c√≥ hi·ªáu qu·∫£ ‚ú®", "success");
        } else {
          showStatus("‚ú® T·∫°o ·∫£nh th√†nh c√¥ng! Ma thu·∫≠t ƒë√£ ho√†n th√†nh ‚ú®", "success");
        }
      }, 500);
    } else {
      showStatus("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫°o ·∫£nh. Vui l√≤ng th·ª≠ g·ª£i √Ω kh√°c", "error");
    }
  } catch (error) {
    console.error("L·ªói khi t·∫°o ·∫£nh:", error);
    showStatus(`‚ùå L·ªói: ${error.message}`, "error");
  } finally {
    setLoading(false);
    generateButton.innerHTML = "‚ú® T·∫°o ·∫£nh ma thu·∫≠t";
  }
}

    
    function showStatus(message, type = "") {
      status.textContent = message;
      status.className = "";
      if (type) {
        if (type === "error" && (message.includes("an to√†n") || message.includes("ch·∫∑n"))) {
          status.classList.add("error-kawaii");
          status.innerHTML = `<span style="font-size:1.2em;">‚ö†Ô∏è</span> ${message} <span style="font-size:1.2em;">‚ú®</span>`;
          if (!useOptimization.checked) {
            setTimeout(() => {
              const suggestion = document.createElement('div');
              suggestion.className = 'optimize-suggestion';
              suggestion.innerHTML = `
                <div style="margin-top: 15px; padding: 10px; background-color: rgba(80, 227, 194, 0.1); border-radius: 8px; font-size: 0.9em; text-align: center; color: #50E3C2; animation: pulse 2s infinite;">
                  üí´ M·∫πo nh·ªè: H√£y b·∫≠t <span style="font-weight: bold; text-decoration: underline; cursor: pointer;" onclick="document.getElementById('useOptimization').checked = true;">T·ªëi ∆∞u ma thu·∫≠t</span> ƒë·ªÉ tƒÉng kh·∫£ nƒÉng th√†nh c√¥ng!
                </div>
              `;
              status.appendChild(suggestion);
            }, 500);
          }
        } else {
          status.classList.add(type);
        }
        status.style.opacity = '0';
        status.style.transform = 'translateY(-10px)';
        setTimeout(() => {
          status.style.opacity = '1';
          status.style.transform = 'translateY(0)';
          status.style.transition = 'all 0.3s ease';
        }, 10);
      }
    }
    
    function setLoading(isLoading) {
      generateButton.disabled = isLoading;
      loader.style.display = isLoading ? "block" : "none";
      promptInput.disabled = isLoading;
    }
    
    function createStars() {
      const stars = document.getElementById('magicStars');
      const count = 20;
      for (let i = 0; i < count; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        const size = Math.random() * 15 + 5;
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.top = `${y}%`;
        star.style.left = `${x}%`;
        star.style.animationDelay = `${Math.random() * 5}s`;
        stars.appendChild(star);
      }
    }
    
    createStars();
    
    function handleFinishReason(finishReason) {
      switch(finishReason) {
        case "IMAGE_SAFETY":
          return "N·ªôi dung ·∫£nh b·ªã h·ªá th·ªëng an to√†n ch·∫∑n. Vui l√≤ng th·ª≠ ·∫£nh ho·∫∑c g·ª£i √Ω kh√°c.";
        case "SAFETY":
          return "N·ªôi dung b·ªã h·ªá th·ªëng an to√†n ch·∫∑n. Vui l√≤ng ch·ªânh s·ª≠a g·ª£i √Ω v√† th·ª≠ l·∫°i.";
        case "RECITATION":
          return "AI kh√¥ng ch·∫Øc ch·∫Øn x·ª≠ l√Ω y√™u c·∫ßu n√†y. Vui l√≤ng th·ª≠ g·ª£i √Ω r√µ r√†ng h∆°n.";
        case "MAX_TOKENS":
          return "N·ªôi dung t·∫°o ra qu√° d√†i. Vui l√≤ng ƒë∆°n gi·∫£n h√≥a y√™u c·∫ßu.";
        case "OTHER":
          return "Y√™u c·∫ßu b·ªã h·ªá th·ªëng ch·∫∑n. Vui l√≤ng b·∫≠t t·ªëi ∆∞u ma thu·∫≠t ho·∫∑c ch·ªânh s·ª≠a g·ª£i √Ω.";
        default:
          return "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh. Vui l√≤ng th·ª≠ l·∫°i sau.";
      }
    }
    
    function handleBlockReason(blockReason) {
      switch(blockReason) {
        case "SAFETY":
          return "N·ªôi dung g·ª£i √Ω b·ªã h·ªá th·ªëng an to√†n ch·∫∑n. Vui l√≤ng ch·ªânh s·ª≠a v√† th·ª≠ l·∫°i.";
        case "OTHER":
          return "G·ª£i √Ω b·ªã h·ªá th·ªëng ch·∫∑n. Vui l√≤ng b·∫≠t t·ªëi ∆∞u ma thu·∫≠t ho·∫∑c d√πng g·ª£i √Ω th√¢n thi·ªán h∆°n.";
        default:
          return `G·ª£i √Ω b·ªã h·ªá th·ªëng ch·∫∑n do l√Ω do ${blockReason}. Vui l√≤ng th·ª≠ g·ª£i √Ω kh√°c.`;
      }
    }
    
    function optimizePrompt(originalPrompt) {
      let cleanedPrompt = sanitizePrompt(originalPrompt);
      if (shouldUseExtraSafety(cleanedPrompt)) {
        return createSupersafePrompt(cleanedPrompt);
      }
      const prefixes = [
        "Create a family-friendly digital art of ",
        "Generate a wholesome image showing ",
        "Illustrate a professional, clean artwork depicting ",
        "Design a creative, positive visualization of ",
        "Make a cheerful, artistic representation of ",
        "Create an educational illustration of "
      ];
      
      const suffixes = [
        ", suitable for all ages",
        ", bright and colorful style",
        ", high quality digital art",
        ", professional illustration",
        ", happy vibes only",
        ", uplifting aesthetic",
        ", in a style appropriate for children"
      ];
      
      const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
      const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
      
      let enhancedPrompt = `${prefix}${cleanedPrompt}${suffix}`;
      
      const safetyHints = [
        ". Create this as a G-rated image suitable for educational purposes.",
        ". This must be appropriate content for classroom use.",
        ". Make this appropriate for a children's book illustration.",
        ". Ensure this follows all community guidelines.",
        ". This is for a school project and must be appropriate.",
        ". This image will be used in an educational context for young students.",
        ". Create this in a positive, uplifting manner with no inappropriate elements."
      ];
      
      const randomHint = safetyHints[Math.floor(Math.random() * safetyHints.length)];
      enhancedPrompt += randomHint;
      
      const qualityTerms = [
        " High resolution.", 
        " Professional quality.", 
        " Detailed illustration.", 
        " Artistic style.", 
        " Vibrant colors.",
        " Child-friendly artwork.",
        " Non-violent imagery.",
        " Positive themes only."
      ];
      
      const numTerms = Math.floor(Math.random() * 3) + 2;
      const shuffledTerms = [...qualityTerms].sort(() => 0.5 - Math.random());
      for (let i = 0; i < numTerms; i++) {
        enhancedPrompt += shuffledTerms[i];
      }
      
      return enhancedPrompt;
    }
    
    function shouldUseExtraSafety(prompt) {
      const highRiskTerms = ["nude", "naked", "sexy", "girl", "boy", "woman", "man", 
        "adult", "body", "skin", "flesh", "intimate", "sensual", "bikini", 
        "underwear", "revealing", "controversial", "realistic", "photo"];
      let riskCount = 0;
      highRiskTerms.forEach(term => {
        if (prompt.toLowerCase().includes(term)) {
          riskCount++;
        }
      });
      return riskCount > 0;
    }
    
    function createSupersafePrompt(prompt) {
      let redesignedPrompt = "Create a cartoon-style, stylized illustration of " + prompt;
      redesignedPrompt += " for a kindergarten classroom poster. Absolutely G-rated content.";
      redesignedPrompt += " Colorful, whimsical, child-friendly art style with no realistic elements.";
      redesignedPrompt += " This must be appropriate for very young children and follow strict educational guidelines.";
      console.log("üîí ƒê√£ b·∫≠t ch·∫ø ƒë·ªô an to√†n si√™u c·∫•p");
      return redesignedPrompt;
    }
    
    function sanitizePrompt(prompt) {
      const problematicTerms = [
        "nude", "naked", "nsfw", "porn", "sexy", "sexual", "explicit", 
        "violence", "violent", "blood", "gore", "weapon", "kill", "death",
        "drug", "cocaine", "heroin", "meth", "illegal", "abuse"
      ];
      let cleanedPrompt = prompt;
      let needsCleaning = false;
      problematicTerms.forEach(term => {
        if (cleanedPrompt.toLowerCase().includes(term)) {
          const regex = new RegExp(term, 'gi');
          cleanedPrompt = cleanedPrompt.replace(regex, 'appropriate');
          needsCleaning = true;
        }
      });
      if (needsCleaning) {
        console.log("‚ö†Ô∏è G·ª£i √Ω ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n");
      }
      return cleanedPrompt;
    }
    
    function processAiText(text) {
      if (!text) return '';
      let processedText = text.replace(/\n/g, '<br>');
      const keywordsPattern = /(\b(?:th√†nh c√¥ng|ho√†n th√†nh|t·∫°o|ma thu·∫≠t|·∫£nh|t·∫°o ra|hi·ªáu ·ª©ng|phong c√°ch|s√°ng t·∫°o)\b)/g;
      processedText = processedText.replace(
        keywordsPattern, 
        '<span style="color: var(--primary-color); font-weight: 600;">$1</span>'
      );
      if (!processedText.includes('?') && !processedText.includes('Ôºü')) {
        processedText += ' üòä';
      }
      if (processedText.trim().endsWith('?') || processedText.trim().endsWith('Ôºü')) {
        processedText = processedText.replace(/[?Ôºü](\s*)$/, '? ü§î$1');
      }
      return processedText;
    }
  </script>
</body>
</html>
